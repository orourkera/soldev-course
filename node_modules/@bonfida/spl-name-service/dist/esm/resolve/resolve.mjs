import{PublicKey as e,SIGNATURE_LENGTH_IN_BYTES as o}from"@solana/web3.js";import{getDomainKeySync as r}from"../utils/getDomainKeySync.mjs";import{NftRecord as t,Tag as n}from"../nft/state.mjs";import{NAME_TOKENIZER_ID as a}from"../nft/const.mjs";import{getRecordKeySync as i}from"../record/getRecordKeySync.mjs";import{Record as s}from"../types/record.mjs";import{getRecordV2Key as d}from"../record_v2/getRecordV2Key.mjs";import{Record as l,Validation as f}from"../node_modules/@bonfida/sns-records/dist/index.mjs";import{DomainDoesNotExist as m,CouldNotFindNftOwner as c,RecordMalformed as w,WrongValidation as u,InvalidRoAError as E,PdaOwnerNotAllowed as p}from"../error.mjs";import{NameRegistryState as h}from"../state.mjs";import{checkSolRecord as v}from"../record/checkSolRecord.mjs";import{retrieveNftOwnerV2 as g}from"../nft/retrieveNftOwnerV2.mjs";const R=async(R,j,A={allowPda:!1})=>{var y;const{pubkey:S}=r(j),[D]=t.findKeySync(S,a),L=i(j,s.SOL),_=d(j,s.SOL),[N,b,B,H]=await R.getMultipleAccountsInfo([D,L,_,S]);if(!(null==H?void 0:H.data))throw new m(`Domain ${j} does not exist`);const I=h.deserialize(H.data);if(null==N?void 0:N.data){if(t.deserialize(N.data).tag===n.ActiveRecord){const e=await g(R,S);if(!e)throw new c;return e}}e:if(null==B?void 0:B.data){const o=l.deserialize(B.data),r=o.getStalenessId(),t=o.getRoAId(),n=o.getContent();if(32!==n.length)throw new w("Record is malformed");if(o.header.rightOfAssociationValidation!==f.Solana||o.header.stalenessValidation!==f.Solana)throw new u;if(!r.equals(I.owner.toBuffer()))break e;if(t.equals(n))return new e(n);throw new E(`The RoA ID shoudl be ${new e(n).toBase58()} but is ${new e(t).toBase58()} `)}if(null==b?void 0:b.data){const r=new TextEncoder,t=Buffer.concat([b.data.slice(h.HEADER_LEN,h.HEADER_LEN+32),L.toBuffer()]),n=r.encode(t.toString("hex"));if(v(n,b.data.slice(h.HEADER_LEN+32,h.HEADER_LEN+32+o),I.owner))return new e(b.data.slice(h.HEADER_LEN,h.HEADER_LEN+32))}if(!e.isOnCurve(I.owner)){if("any"===A.allowPda)return I.owner;if(A.allowPda){const e=await R.getAccountInfo(I.owner);if(null===(y=A.programIds)||void 0===y?void 0:y.some((o=>{var r;return null===(r=null==e?void 0:e.owner)||void 0===r?void 0:r.equals(o)})))return I.owner;throw new p(`The Program ${null==e?void 0:e.owner.toBase58()} is not allowed`)}throw new p}return I.owner};export{R as resolve};
//# sourceMappingURL=resolve.mjs.map
